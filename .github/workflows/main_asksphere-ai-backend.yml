# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
     # More GitHub Actions for Azure: https://github.com/Azure/actions
     # More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

     name: Build and deploy Python app to Azure Web App - asksphere-ai-backend

     on:
       push:
         branches:
           - main
       workflow_dispatch:

     jobs:
       build:
         runs-on: ubuntu-latest
         permissions:
           contents: read #This is required for actions/checkout

         steps:
           - uses: actions/checkout@v4

           - name: Set up Python version
             uses: actions/setup-python@v5
             with:
               python-version: '3.11'

           - name: Create and start virtual environment
             run: |
               python -m venv venv
               source venv/bin/activate
           
           - name: Install dependencies
             run: pip install -r requirements.txt
             
           # Optional: Add step to run tests here (PyTest, Django test suites, etc.)

           - name: Zip artifact for deployment
             run: zip release.zip ./* -r

           - name: Upload artifact for deployment jobs
             uses: actions/upload-artifact@v4
             with:
               name: python-app
               path: |
                 release.zip
                 !venv/

       deploy:
         runs-on: ubuntu-latest
         needs: build
         
         permissions:
           id-token: write #This is required for requesting the JWT
           contents: read #This is required for actions/checkout

         steps:
           - name: Download artifact from build job
             uses: actions/download-artifact@v4
             with:
               name: python-app

           - name: Unzip artifact for deployment
             run: unzip release.zip

           - name: Login to Azure
             uses: azure/login@v2
             with:
               client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_CFD152A77AFC43C6A7B4E7C256E0D437 }}
               tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_CD8E632DF9EC4887ADFF5C08A7207A42 }}
               subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_A78E1AEA1F6140BD931599353BCE01C8 }}

           - name: 'Deploy to Azure Web App'
             uses: azure/webapps-deploy@v3
             id: deploy-to-webapp
             with:
               app-name: 'asksphere-ai-backend'
               slot-name: 'Production'
               app-location: '/'  # Root of the repository
               output-location: '.'  # Unzipped content location
               api-location: ''  # No separate API